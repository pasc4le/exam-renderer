/* esm.sh - ts-fsrs@5.2.3 */
var d=(n=>(n[n.New=0]="New",n[n.Learning=1]="Learning",n[n.Review=2]="Review",n[n.Relearning=3]="Relearning",n))(d||{}),o=(n=>(n[n.Manual=0]="Manual",n[n.Again=1]="Again",n[n.Hard=2]="Hard",n[n.Good=3]="Good",n[n.Easy=4]="Easy",n))(o||{}),c=class n{static card(t){return{...t,state:n.state(t.state),due:n.time(t.due),last_review:t.last_review?n.time(t.last_review):void 0}}static rating(t){if(typeof t=="string"){let e=t.charAt(0).toUpperCase(),i=t.slice(1).toLowerCase(),s=o[`${e}${i}`];if(s===void 0)throw new Error(`Invalid rating:[${t}]`);return s}else if(typeof t=="number")return t;throw new Error(`Invalid rating:[${t}]`)}static state(t){if(typeof t=="string"){let e=t.charAt(0).toUpperCase(),i=t.slice(1).toLowerCase(),s=d[`${e}${i}`];if(s===void 0)throw new Error(`Invalid state:[${t}]`);return s}else if(typeof t=="number")return t;throw new Error(`Invalid state:[${t}]`)}static time(t){let e=new Date(t);if(typeof t=="object"&&t!==null&&!Number.isNaN(Date.parse(t)||+e))return e;if(typeof t=="string"){let i=Date.parse(t);if(Number.isNaN(i))throw new Error(`Invalid date:[${t}]`);return new Date(i)}else if(typeof t=="number")return new Date(t);throw new Error(`Invalid date:[${t}]`)}static review_log(t){return{...t,due:n.time(t.due),rating:n.rating(t.rating),state:n.state(t.state),review:n.time(t.review)}}};Date.prototype.scheduler=function(n,t){return y(this,n,t)};Date.prototype.diff=function(n,t){return v(this,n,t)};Date.prototype.format=function(){return O(this)};Date.prototype.dueFormat=function(n,t,e){return j(this,n,t,e)};function y(n,t,e){return new Date(e?c.time(n).getTime()+t*24*60*60*1e3:c.time(n).getTime()+t*60*1e3)}function v(n,t,e){if(!n||!t)throw new Error("Invalid date");let i=c.time(n).getTime()-c.time(t).getTime(),s=0;switch(e){case"days":s=Math.floor(i/(1440*60*1e3));break;case"minutes":s=Math.floor(i/(60*1e3));break}return s}function O(n){let t=c.time(n),e=t.getFullYear(),i=t.getMonth()+1,s=t.getDate(),r=t.getHours(),a=t.getMinutes(),l=t.getSeconds();return`${e}-${b(i)}-${b(s)} ${b(r)}:${b(a)}:${b(l)}`}function b(n){return n<10?`0${n}`:`${n}`}var I=[60,60,24,31,12],F=["second","min","hour","day","month","year"];function j(n,t,e,i=F){n=c.time(n),t=c.time(t),i.length!==F.length&&(i=F);let s=n.getTime()-t.getTime(),r=0;for(s/=1e3,r=0;r<I.length&&!(s<I[r]);r++)s/=I[r];return`${Math.floor(s)}${e?i[r]:""}`}function ct(n){return c.time(n)}function ht(n){return c.state(n)}function ut(n){return c.rating(n)}var Y=Object.freeze([o.Again,o.Hard,o.Good,o.Easy]),W=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function Z(n,t,e){let i=1;for(let a of W)i+=a.factor*Math.max(Math.min(n,a.end)-a.start,0);n=Math.min(n,e);let s=Math.max(2,Math.round(n-i)),r=Math.min(Math.round(n+i),e);return n>t&&(s=Math.max(s,t+1)),s=Math.min(s,r),{min_ivl:s,max_ivl:r}}function g(n,t,e){return Math.min(Math.max(n,t),e)}function X(n,t){let e=Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()),i=Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate());return Math.floor((i-e)/864e5)}var B=n=>{let t=n.slice(-1),e=parseInt(n.slice(0,-1),10);if(Number.isNaN(e)||!Number.isFinite(e)||e<0)throw new Error(`Invalid step value: ${n}`);switch(t){case"m":return e;case"h":return e*60;case"d":return e*1440;default:throw new Error(`Invalid step unit: ${n}, expected m/h/d`)}},K=(n,t,e)=>{let i=t===d.Relearning||t===d.Review?n.relearning_steps:n.learning_steps,s=i.length;if(s===0||e>=s)return{};let r=i[0],a=B,l=()=>a(r),h=()=>{if(s===1)return Math.round(a(r)*1.5);let f=i[1];return Math.round((a(r)+a(f))/2)},u=f=>f<0||f>=s?null:i[f],_=f=>a(f),m={},w=u(Math.max(0,e));if(t===d.Review)return m[o.Again]={scheduled_minutes:a(w),next_step:0},m;{m[o.Again]={scheduled_minutes:l(),next_step:0},m[o.Hard]={scheduled_minutes:h(),next_step:e};let f=u(e+1);if(f){let x=_(f);x&&(m[o.Good]={scheduled_minutes:Math.round(x),next_step:e+1})}}return m};function V(){let n=this.review_time.getTime(),t=this.current.reps,e=this.current.difficulty*this.current.stability;return`${n}_${t}_${e}`}function dt(n){return function(){let t=Reflect.get(this.current,n)??0,e=this.current.reps;return String(t+e||0)}}var L=(n=>(n.SCHEDULER="Scheduler",n.LEARNING_STEPS="LearningSteps",n.SEED="Seed",n))(L||{}),S=class{last;current;review_time;next=new Map;algorithm;strategies;elapsed_days=0;constructor(t,e,i,s){this.algorithm=i,this.last=c.card(t),this.current=c.card(t),this.review_time=c.time(e),this.strategies=s,this.init()}checkGrade(t){if(!Number.isFinite(t)||t<0||t>4)throw new Error(`Invalid grade "${t}",expected 1-4`)}init(){let{state:t,last_review:e}=this.current,i=0;t!==d.New&&e&&(i=X(e,this.review_time)),this.current.last_review=this.review_time,this.elapsed_days=i,this.current.elapsed_days=i,this.current.reps+=1;let s=V;if(this.strategies){let r=this.strategies.get(L.SEED);r&&(s=r)}this.algorithm.seed=s.call(this)}preview(){return{[o.Again]:this.review(o.Again),[o.Hard]:this.review(o.Hard),[o.Good]:this.review(o.Good),[o.Easy]:this.review(o.Easy),[Symbol.iterator]:this.previewIterator.bind(this)}}*previewIterator(){for(let t of Y)yield this.review(t)}review(t){let{state:e}=this.last,i;switch(this.checkGrade(t),e){case d.New:i=this.newState(t);break;case d.Learning:case d.Relearning:i=this.learningState(t);break;case d.Review:i=this.reviewState(t);break}return i}buildLog(t){let{last_review:e,due:i,elapsed_days:s}=this.last;return{rating:t,state:this.current.state,due:e||i,stability:this.current.stability,difficulty:this.current.difficulty,elapsed_days:this.elapsed_days,last_elapsed_days:s,scheduled_days:this.current.scheduled_days,learning_steps:this.current.learning_steps,review:this.review_time}}},D=class{c;s0;s1;s2;constructor(t){let e=J();this.c=1,this.s0=e(" "),this.s1=e(" "),this.s2=e(" "),t==null&&(t=Date.now()),this.s0-=e(t),this.s0<0&&(this.s0+=1),this.s1-=e(t),this.s1<0&&(this.s1+=1),this.s2-=e(t),this.s2<0&&(this.s2+=1)}next(){let t=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.c=t|0,this.s2=t-this.c,this.s2}set state(t){this.c=t.c,this.s0=t.s0,this.s1=t.s1,this.s2=t.s2}get state(){return{c:this.c,s0:this.s0,s1:this.s1,s2:this.s2}}};function J(){let n=4022871197;return function(e){e=String(e);for(let i=0;i<e.length;i++){n+=e.charCodeAt(i);let s=.02519603282416938*n;n=s>>>0,s-=n,s*=n,n=s>>>0,s-=n,n+=s*4294967296}return(n>>>0)*23283064365386963e-26}}function Q(n){let t=new D(n),e=()=>t.next();return e.int32=()=>t.next()*4294967296|0,e.double=()=>e()+(e()*2097152|0)*11102230246251565e-32,e.state=()=>t.state,e.importState=i=>(t.state=i,e),e}var tt="5.2.3",et=.9,it=36500,st=!1,A=!0,rt=Object.freeze(["1m","10m"]),nt=Object.freeze(["10m"]),_t=`v${tt} using FSRS-6.0`,p=.001,ft=36500,M=100,k=.5,at=.1542,U=Object.freeze([.212,1.2931,2.3065,8.2956,6.4133,.8334,3.0194,.001,1.8722,.1666,.796,1.4835,.0614,.2629,1.6483,.6014,1.8729,.5425,.0912,.0658,at]),ot=2,lt=(n,t=A)=>[[p,M],[p,M],[p,M],[p,M],[1,10],[.001,4],[.001,4],[.001,.75],[0,4.5],[0,.8],[.001,3.5],[.001,5],[.001,.25],[.001,.9],[0,4],[0,1],[1,6],[0,n],[0,n],[t?.01:0,.8],[.1,.8]],$=(n,t,e=A)=>{let i=ot;if(Math.max(0,t)>1){let r=-(Math.log(n[11])+Math.log(Math.pow(2,n[13])-1)+n[14]*.3)/t;i=g(+r.toFixed(8),.01,2)}return lt(i,e).slice(0,n.length).map(([r,a],l)=>g(n[l]||0,r,a))},gt=n=>{if(n.find(e=>!Number.isFinite(e)&&!Number.isNaN(e))!==void 0)throw Error(`Non-finite or NaN value in parameters ${n}`);if(![17,19,21].includes(n.length))throw Error(`Invalid parameter length: ${n.length}. Must be 17, 19 or 21 for FSRSv4, 5 and 6 respectively.`);return n},C=(n,t=0,e=A)=>{if(n===void 0)return[...U];switch(n.length){case 21:return $(Array.from(n),t,e);case 19:return console.debug("[FSRS-6]auto fill w from 19 to 21 length"),$(Array.from(n),t,e).concat([0,k]);case 17:{let i=$(Array.from(n),t,e);return i[4]=+(i[5]*2+i[4]).toFixed(8),i[5]=+(Math.log(i[5]*3+1)/3).toFixed(8),i[6]=+(i[6]+.5).toFixed(8),console.debug("[FSRS-6]auto fill w from 17 to 21 length"),i.concat([0,0,0,k])}default:return console.warn("[FSRS]Invalid parameters length, using default parameters"),[...U]}},q=n=>{let t=Array.isArray(n?.learning_steps)?n.learning_steps:rt,e=Array.isArray(n?.relearning_steps)?n.relearning_steps:nt,i=n?.enable_short_term??A,s=C(n?.w,e.length,i);return{request_retention:n?.request_retention||et,maximum_interval:n?.maximum_interval||it,w:s,enable_fuzz:n?.enable_fuzz??st,enable_short_term:i,learning_steps:t,relearning_steps:e}};function R(n,t){let e={due:n?c.time(n):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,learning_steps:0,state:d.New,last_review:void 0};return t&&typeof t=="function"?t(e):e}var P=n=>{let t=typeof n=="number"?-n:-n[20],e=Math.exp(Math.pow(t,-1)*Math.log(.9))-1;return{decay:t,factor:+e.toFixed(8)}};function T(n,t,e){let{decay:i,factor:s}=P(n);return+Math.pow(1+s*t/e,i).toFixed(8)}var G=class{param;intervalModifier;_seed;constructor(t){this.param=new Proxy(q(t),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention),this.forgetting_curve=T.bind(this,this.param.w)}get interval_modifier(){return this.intervalModifier}set seed(t){this._seed=t}calculate_interval_modifier(t){if(t<=0||t>1)throw new Error("Requested retention rate should be in the range (0,1]");let{decay:e,factor:i}=P(this.param.w);return+((Math.pow(t,1/e)-1)/i).toFixed(8)}get parameters(){return this.param}set parameters(t){this.update_parameters(t)}params_handler_proxy(){let t=this;return{set:function(e,i,s){return i==="request_retention"&&Number.isFinite(s)?t.intervalModifier=t.calculate_interval_modifier(Number(s)):i==="w"&&(s=C(s,e.relearning_steps.length,e.enable_short_term),t.forgetting_curve=T.bind(this,s),t.intervalModifier=t.calculate_interval_modifier(Number(e.request_retention))),Reflect.set(e,i,s),!0}}}update_parameters(t){let e=q(t);for(let i in e){let s=i;this.param[s]=e[s]}}init_stability(t){return Math.max(this.param.w[t-1],.1)}init_difficulty(t){return+(this.param.w[4]-Math.exp((t-1)*this.param.w[5])+1).toFixed(8)}apply_fuzz(t,e){if(!this.param.enable_fuzz||t<2.5)return Math.round(t);let s=Q(this._seed)(),{min_ivl:r,max_ivl:a}=Z(t,e,this.param.maximum_interval);return Math.floor(s*(a-r+1)+r)}next_interval(t,e){let i=Math.min(Math.max(1,Math.round(t*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(i,e)}linear_damping(t,e){return+(t*(10-e)/9).toFixed(8)}next_difficulty(t,e){let i=-this.param.w[6]*(e-3),s=t+this.linear_damping(i,t);return g(this.mean_reversion(this.init_difficulty(o.Easy),s),1,10)}mean_reversion(t,e){return+(this.param.w[7]*t+(1-this.param.w[7])*e).toFixed(8)}next_recall_stability(t,e,i,s){let r=o.Hard===s?this.param.w[15]:1,a=o.Easy===s?this.param.w[16]:1;return+g(e*(1+Math.exp(this.param.w[8])*(11-t)*Math.pow(e,-this.param.w[9])*(Math.exp((1-i)*this.param.w[10])-1)*r*a),p,36500).toFixed(8)}next_forget_stability(t,e,i){return+g(this.param.w[11]*Math.pow(t,-this.param.w[12])*(Math.pow(e+1,this.param.w[13])-1)*Math.exp((1-i)*this.param.w[14]),p,36500).toFixed(8)}next_short_term_stability(t,e){let i=Math.pow(t,-this.param.w[19])*Math.exp(this.param.w[17]*(e-3+this.param.w[18])),s=e>=3?Math.max(i,1):i;return+g(t*s,p,36500).toFixed(8)}forgetting_curve;next_state(t,e,i){let{difficulty:s,stability:r}=t??{difficulty:0,stability:0};if(e<0)throw new Error(`Invalid delta_t "${e}"`);if(i<0||i>4)throw new Error(`Invalid grade "${i}"`);if(s===0&&r===0)return{difficulty:g(this.init_difficulty(i),1,10),stability:this.init_stability(i)};if(i===0)return{difficulty:s,stability:r};if(s<1||r<p)throw new Error(`Invalid memory state { difficulty: ${s}, stability: ${r} }`);let a=this.forgetting_curve(e,r),l=this.next_recall_stability(s,r,a,i),h=this.next_forget_stability(s,r,a),u=this.next_short_term_stability(r,i),_=l;if(i===1){let[w,f]=[0,0];this.param.enable_short_term&&(w=this.param.w[17],f=this.param.w[18]);let x=r/Math.exp(w*f);_=g(+x.toFixed(8),p,h)}return e===0&&this.param.enable_short_term&&(_=u),{difficulty:this.next_difficulty(s,i),stability:_}}},E=class extends S{learningStepsStrategy;constructor(t,e,i,s){super(t,e,i,s);let r=K;if(this.strategies){let a=this.strategies.get(L.LEARNING_STEPS);a&&(r=a)}this.learningStepsStrategy=r}getLearningInfo(t,e){let i=this.algorithm.parameters;t.learning_steps=t.learning_steps||0;let s=this.learningStepsStrategy(i,t.state,this.current.state===d.Learning&&e!==o.Again&&e!==o.Hard?t.learning_steps+1:t.learning_steps),r=Math.max(0,s[e]?.scheduled_minutes??0),a=Math.max(0,s[e]?.next_step??0);return{scheduled_minutes:r,next_steps:a}}applyLearningSteps(t,e,i){let{scheduled_minutes:s,next_steps:r}=this.getLearningInfo(this.current,e);if(s>0&&s<1440)t.learning_steps=r,t.scheduled_days=0,t.state=i,t.due=y(this.review_time,Math.round(s),!1);else if(t.state=d.Review,s>=1440)t.learning_steps=r,t.due=y(this.review_time,Math.round(s),!1),t.scheduled_days=Math.floor(s/1440);else{t.learning_steps=0;let a=this.algorithm.next_interval(t.stability,this.elapsed_days);t.scheduled_days=a,t.due=y(this.review_time,a,!0)}}newState(t){let e=this.next.get(t);if(e)return e;let i=c.card(this.current);i.difficulty=g(this.algorithm.init_difficulty(t),1,10),i.stability=this.algorithm.init_stability(t),this.applyLearningSteps(i,t,d.Learning);let s={card:i,log:this.buildLog(t)};return this.next.set(t,s),s}learningState(t){let e=this.next.get(t);if(e)return e;let{state:i,difficulty:s,stability:r}=this.last,a=c.card(this.current);a.difficulty=this.algorithm.next_difficulty(s,t),a.stability=this.algorithm.next_short_term_stability(r,t),this.applyLearningSteps(a,t,i);let l={card:a,log:this.buildLog(t)};return this.next.set(t,l),l}reviewState(t){let e=this.next.get(t);if(e)return e;let i=this.elapsed_days,{difficulty:s,stability:r}=this.last,a=this.algorithm.forgetting_curve(i,r),l=c.card(this.current),h=c.card(this.current),u=c.card(this.current),_=c.card(this.current);this.next_ds(l,h,u,_,s,r,a),this.next_interval(h,u,_,i),this.next_state(h,u,_),this.applyLearningSteps(l,o.Again,d.Relearning),l.lapses+=1;let m={card:l,log:this.buildLog(o.Again)},w={card:h,log:super.buildLog(o.Hard)},f={card:u,log:super.buildLog(o.Good)},x={card:_,log:super.buildLog(o.Easy)};return this.next.set(o.Again,m),this.next.set(o.Hard,w),this.next.set(o.Good,f),this.next.set(o.Easy,x),this.next.get(t)}next_ds(t,e,i,s,r,a,l){t.difficulty=this.algorithm.next_difficulty(r,o.Again);let h=a/Math.exp(this.algorithm.parameters.w[17]*this.algorithm.parameters.w[18]),u=this.algorithm.next_forget_stability(r,a,l);t.stability=g(+h.toFixed(8),p,u),e.difficulty=this.algorithm.next_difficulty(r,o.Hard),e.stability=this.algorithm.next_recall_stability(r,a,l,o.Hard),i.difficulty=this.algorithm.next_difficulty(r,o.Good),i.stability=this.algorithm.next_recall_stability(r,a,l,o.Good),s.difficulty=this.algorithm.next_difficulty(r,o.Easy),s.stability=this.algorithm.next_recall_stability(r,a,l,o.Easy)}next_interval(t,e,i,s){let r,a;r=this.algorithm.next_interval(t.stability,s),a=this.algorithm.next_interval(e.stability,s),r=Math.min(r,a),a=Math.max(a,r+1);let l=Math.max(this.algorithm.next_interval(i.stability,s),a+1);t.scheduled_days=r,t.due=y(this.review_time,r,!0),e.scheduled_days=a,e.due=y(this.review_time,a,!0),i.scheduled_days=l,i.due=y(this.review_time,l,!0),s.scheduled_days=u,s.due=y(this.review_time,u,!0)}next_state(t,e,i){t.state=d.Review,t.learning_steps=0,e.state=d.Review,e.learning_steps=0,i.state=d.Review,i.learning_steps=0}},N=class extends S{newState(t){let e=this.next.get(t);if(e)return e;this.current.scheduled_days=0,this.current.elapsed_days=0;let i=c.card(this.current),s=c.card(this.current),r=c.card(this.current),a=c.card(this.current);return this.init_ds(i,s,r,a),this.next_interval(i,s,r,a,0),this.next_state(i,s,r,a),this.update_next(i,s,r,a),this.next.get(t)}init_ds(t,e,i,s){t.difficulty=g(this.algorithm.init_difficulty(o.Again),1,10),t.stability=this.algorithm.init_stability(o.Again),e.difficulty=g(this.algorithm.init_difficulty(o.Hard),1,10),e.stability=this.algorithm.init_stability(o.Hard),i.difficulty=g(this.algorithm.init_difficulty(o.Good),1,10),i.stability=this.algorithm.init_stability(o.Good),s.difficulty=g(this.algorithm.init_difficulty(o.Easy),1,10),s.stability=this.algorithm.init_stability(o.Easy)}learningState(t){return this.reviewState(t)}reviewState(t){let e=this.next.get(t);if(e)return e;let i=this.elapsed_days,{difficulty:s,stability:r}=this.last,a=this.algorithm.forgetting_curve(i,r),l=c.card(this.current),h=c.card(this.current),u=c.card(this.current),_=c.card(this.current);return this.next_ds(l,h,u,_,s,r,a),this.next_interval(l,h,u,_,i),this.next_state(l,h,u,_),l.lapses+=1,this.update_next(l,h,u,_),this.next.get(t)}next_ds(t,e,i,s,r,a,l){t.difficulty=this.algorithm.next_difficulty(r,o.Again);let h=this.algorithm.next_forget_stability(r,a,l);t.stability=g(a,p,h),e.difficulty=this.algorithm.next_difficulty(r,o.Hard),e.stability=this.algorithm.next_recall_stability(r,a,l,o.Hard),i.difficulty=this.algorithm.next_difficulty(r,o.Good),i.stability=this.algorithm.next_recall_stability(r,a,l,o.Good),s.difficulty=this.algorithm.next_difficulty(r,o.Easy),s.stability=this.algorithm.next_recall_stability(r,a,l,o.Easy)}next_interval(t,e,i,s,r){let a,l,h,u;a=this.algorithm.next_interval(t.stability,r),l=this.algorithm.next_interval(e.stability,r),h=this.algorithm.next_interval(i.stability,r),u=this.algorithm.next_interval(s.stability,r),a=Math.min(a,l),l=Math.max(l,a+1),h=Math.max(h,l+1),u=Math.max(u,h+1),t.scheduled_days=a,t.due=y(this.review_time,a,!0),e.scheduled_days=l,e.due=y(this.review_time,l,!0),i.scheduled_days=h,i.due=y(this.review_time,h,!0),s.scheduled_days=u,s.due=y(this.review_time,u,!0)}next_state(t,e,i,s){t.state=d.Review,t.learning_steps=0,e.state=d.Review,e.learning_steps=0,i.state=d.Review,i.learning_steps=0,s.state=d.Review,s.learning_steps=0}update_next(t,e,i,s){let r={card:t,log:this.buildLog(o.Again)},a={card:e,log:super.buildLog(o.Hard)},l={card:i,log:super.buildLog(o.Good)},h={card:s,log:super.buildLog(o.Easy)};this.next.set(o.Again,r),this.next.set(o.Hard,a),this.next.set(o.Good,l),this.next.set(o.Easy,h)}},z=class{fsrs;constructor(t){this.fsrs=t}replay(t,e,i){return this.fsrs.next(t,e,i)}handleManualRating(t,e,i,s,r,a,l){if(typeof e>"u")throw new Error("reschedule: state is required for manual rating");let h,u;if(e===d.New)h={rating:o.Manual,state:e,due:l??i,stability:t.stability,difficulty:t.difficulty,elapsed_days:s,last_elapsed_days:t.elapsed_days,scheduled_days:t.scheduled_days,learning_steps:t.learning_steps,review:i},u=R(i),u.last_review=i;else{if(typeof l>"u")throw new Error("reschedule: due is required for manual rating");let _=v(l,i,"days");h={rating:o.Manual,state:t.state,due:t.last_review||t.due,stability:t.stability,difficulty:t.difficulty,elapsed_days:s,last_elapsed_days:t.elapsed_days,scheduled_days:t.scheduled_days,learning_steps:t.learning_steps,review:i},u={...t,state:e,due:l,last_review:i,stability:r||t.stability,difficulty:a||t.difficulty,elapsed_days:s,scheduled_days:_,reps:t.reps+1}}return{card:u,log:h}}reschedule(t,e){let i=[],s=R(t.due);for(let r of e){let a;if(r.review=c.time(r.review),r.rating===o.Manual){let l=0;s.state!==d.New&&s.last_review&&(l=v(r.review,s.last_review,"days")),a=this.handleManualRating(s,r.state,r.review,l,r.stability,r.difficulty,r.due?c.time(r.due):void 0)}else a=this.replay(s,r.review,r.rating);i.push(a),s=a.card}return i}calculateManualRecord(t,e,i,s){if(!i)return null;let{card:r,log:a}=i,l=c.card(t);return l.due.getTime()===r.due.getTime()?null:(l.scheduled_days=v(r.due,l.due,"days"),this.handleManualRating(l,r.state,c.time(e),a.elapsed_days,s?r.stability:void 0,s?r.difficulty:void 0,r.due))}},H=class extends G{strategyHandler=new Map;Scheduler;constructor(t){super(t);let{enable_short_term:e}=this.parameters;this.Scheduler=e?E:N}params_handler_proxy(){let t=this;return{set:function(e,i,s){return i==="request_retention"&&Number.isFinite(s)?t.intervalModifier=t.calculate_interval_modifier(Number(s)):i==="enable_short_term"?t.Scheduler=s===!0?E:N:i==="w"&&(s=C(s,e.relearning_steps.length,e.enable_short_term),t.forgetting_curve=T.bind(this,s),t.intervalModifier=t.calculate_interval_modifier(Number(e.request_retention))),Reflect.set(e,i,s),!0}}}useStrategy(t,e){return this.strategyHandler.set(t,e),this}clearStrategy(t){return t?this.strategyHandler.delete(t):this.strategyHandler.clear(),this}getScheduler(t,e){let s=this.strategyHandler.get(L.SCHEDULER)||this.Scheduler;return new s(t,e,this,this.strategyHandler)}repeat(t,e,i){let r=this.getScheduler(t,e).preview();return i&&typeof i=="function"?i(r):r}next(t,e,i,s){let r=this.getScheduler(t,e),a=c.rating(i);if(a===o.Manual)throw new Error("Cannot review a manual rating");let l=r.review(a);return s&&typeof s=="function"?s(l):l}get_retrievability(t,e,i=!0){let s=c.card(t);e=e?c.time(e):new Date;let r=s.state!==d.New?Math.max(v(e,s.last_review,"days"),0):0,a=s.state!==d.New?this.forgetting_curve(r,+s.stability.toFixed(8)):0;return i?`${(a*100).toFixed(2)}%`:a}rollback(t,e,i){let s=c.card(t),r=c.review_log(e);if(r.rating===o.Manual)throw new Error("Cannot rollback a manual rating");let a,l,h;switch(r.state){case d.New:a=r.due,l=void 0,h=0;break;case d.Learning:case d.Relearning:case d.Review:a=r.review,l=r.due,h=s.lapses-(r.rating===o.Again&&r.state===d.Review?1:0);break}let u={...s,due:a,stability:r.stability,difficulty:r.difficulty,elapsed_days:r.last_elapsed_days,scheduled_days:r.scheduled_days,reps:Math.max(0,s.reps-1),lapses:Math.max(0,h),learning_steps:r.learning_steps,state:r.state,last_review:l};return i&&typeof i=="function"?i(u):u}forget(t,e,i=!1,s){let r=c.card(t);e=c.time(e);let a=r.state===d.New?0:v(e,r.due,"days"),l={rating:o.Manual,state:r.state,due:r.due,stability:r.stability,difficulty:r.difficulty,elapsed_days:0,last_elapsed_days:r.elapsed_days,scheduled_days:a,learning_steps:r.learning_steps,review:e},u={card:{...r,due:e,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:i?0:r.reps,lapses:i?0:r.lapses,learning_steps:0,state:d.New,last_review:r.last_review},log:l};return s&&typeof s=="function"?s(u):u}reschedule(t,e=[],i={}){let{recordLogHandler:s,reviewsOrderBy:r,skipManual:a=!0,now:l=new Date,update_memory_state:h=!1}=i;r&&typeof r=="function"&&e.sort(r),a&&(e=e.filter(x=>x.rating!==o.Manual));let u=new z(this),_=u.reschedule(i.first_card||R(),e),m=_.length,w=c.card(t),f=u.calculateManualRecord(w,l,m?_[m-1]:void 0,h);return s&&typeof s=="function"?{collections:_.map(s),reschedule_item:f?s(f):null}:{collections:_,reschedule_item:f}}},mt=n=>new H(n||{});export{S as AbstractScheduler,K as BasicLearningStepsStrategy,lt as CLAMP_PARAMETERS,B as ConvertStepUnitToMinutes,V as DefaultInitSeedStrategy,H as FSRS,k as FSRS5_DEFAULT_DECAY,at as FSRS6_DEFAULT_DECAY,G as FSRSAlgorithm,_t as FSRSVersion,dt as GenSeedStrategyWithCardId,Y as Grades,M as INIT_S_MAX,o as Rating,ft as S_MAX,p as S_MIN,d as State,L as StrategyMode,c as TypeConvert,ot as W17_W18_Ceiling,gt as checkParameters,g as clamp,$ as clipParameters,P as computeDecayFactor,R as createEmptyCard,X as dateDiffInDays,v as date_diff,y as date_scheduler,st as default_enable_fuzz,A as default_enable_short_term,rt as default_learning_steps,it as default_maximum_interval,nt as default_relearning_steps,et as default_request_retention,U as default_w,ct as fixDate,ut as fixRating,ht as fixState,T as forgetting_curve,O as formatDate,mt as fsrs,q as generatorParameters,Z as get_fuzz_range,C as migrateParameters,j as show_diff_message};
//# sourceMappingURL=ts-fsrs.mjs.map